# å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨æµ‹é‡å‚æ•°æŒ‡å— | Using Measurement Parameters in Worker Thread Guide

## ğŸ“‹ æ¦‚è¿° | Overview

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨`visualWorkThread`å·¥ä½œçº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨å·²ä¿å­˜çš„æµ‹é‡æ¨¡æ¿å‚æ•°ï¼ŒåŒ…æ‹¬HOBJåŒºåŸŸæ–‡ä»¶ã€TUPå‚æ•°æ–‡ä»¶å’ŒJSONé…ç½®ä¿¡æ¯ã€‚

This guide provides detailed instructions on how to properly use saved measurement template parameters in the `visualWorkThread`, including HOBJ region files, TUP parameter files, and JSON configuration information.

## ğŸ¯ ä¸»è¦åŠŸèƒ½ | Key Features

### 1. å‚æ•°æ–‡ä»¶ç±»å‹ | Parameter File Types

- **ğŸ“ HOBJåŒºåŸŸæ–‡ä»¶ | HOBJ Region Files**
  - `m_Measyre_Rect1.hobj` - ç¬¬ä¸€ä¸ªæµ‹é‡åŒºåŸŸ
  - `m_Measyre_Rect2.hobj` - ç¬¬äºŒä¸ªæµ‹é‡åŒºåŸŸ

- **ğŸ“Š TUPå‚æ•°æ–‡ä»¶ | TUP Parameter Files**
  - `è·ç¦»æµ‹é‡æ¨¡æ¿_measure_params.tup` - åŒ…å«è¾¹ç¼˜é˜ˆå€¼å’Œæµ‹é‡ç²¾åº¦

- **âš™ï¸ JSONé…ç½®æ–‡ä»¶ | JSON Configuration Files**
  - `è·ç¦»æµ‹é‡æ¨¡æ¿_measure_template_info.json` - æ¨¡æ¿å…ƒä¿¡æ¯

## ğŸš€ ä½¿ç”¨æ­¥éª¤ | Usage Steps

### æ­¥éª¤1ï¼šè®¾ç½®ä»»åŠ¡å‚æ•° | Step 1: Set Task Parameters

```cpp
// åœ¨ä¸»çº¿ç¨‹ä¸­è®¾ç½®æµ‹é‡ä»»åŠ¡å‚æ•°
VisualTaskParams params;
params.taskType = "Measure";
params.templateName = "è·ç¦»æµ‹é‡æ¨¡æ¿";
params.measureType = "Distance";
params.edgeThreshold = 30;           // è¾¹ç¼˜æ£€æµ‹é˜ˆå€¼
params.measurePrecision = 0.01;      // æµ‹é‡ç²¾åº¦
params.isValid = true;

// å°†å‚æ•°ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹
m_visualWorkThread->setTaskParams(params);
```

### æ­¥éª¤2ï¼šåŠ è½½æµ‹é‡æ¨¡æ¿å‚æ•° | Step 2: Load Measurement Template Parameters

```cpp
// åœ¨å·¥ä½œçº¿ç¨‹ä¸­åŠ è½½æ¨¡æ¿å‚æ•°
bool success = loadMeasureTemplateParams("è·ç¦»æµ‹é‡æ¨¡æ¿");
if (!success) {
    LOG_ERROR("æµ‹é‡æ¨¡æ¿å‚æ•°åŠ è½½å¤±è´¥");
    return;
}
```

### æ­¥éª¤3ï¼šæ‰§è¡Œæµ‹é‡ä»»åŠ¡ | Step 3: Execute Measurement Task

```cpp
// å¤„ç†å•ä¸ªå›¾åƒçš„æµ‹é‡ä»»åŠ¡
QString imagePath = "path/to/your/image.bmp";
processMeasureTask(imagePath);

// æˆ–æ‰¹é‡å¤„ç†
startBatchProcessing();
```

## ğŸ”§ æ ¸å¿ƒæ–¹æ³•è¯¦è§£ | Core Method Details

### ğŸ¯ `loadMeasureTemplateParams()` æ–¹æ³•

**åŠŸèƒ½**ï¼šä»å·²ä¿å­˜çš„æ–‡ä»¶ä¸­åŠ è½½å®Œæ•´çš„æµ‹é‡æ¨¡æ¿å‚æ•°

**å‚æ•°åŠ è½½è¿‡ç¨‹**ï¼š

1. **è¯»å–TUPå‚æ•°æ–‡ä»¶**
   ```cpp
   HTuple measureParams;
   ReadTuple(paramFilePath.toStdString().c_str(), &measureParams);
   ```

2. **åŠ è½½HOBJåŒºåŸŸæ–‡ä»¶**
   ```cpp
   ReadObject(&m_Measyre_Rect1, rect1Path.toStdString().c_str());
   ReadObject(&m_Measyre_Rect2, rect2Path.toStdString().c_str());
   ```

3. **è§£æJSONé…ç½®ä¿¡æ¯**
   ```cpp
   QJsonDocument jsonDoc = QJsonDocument::fromJson(jsonData);
   QJsonObject jsonObj = jsonDoc.object();
   ```

### ğŸ“ `processMeasurement()` æ–¹æ³•

**æ”¹è¿›åŠŸèƒ½**ï¼š

1. **å‚æ•°éªŒè¯**ï¼šç¡®ä¿æµ‹é‡å‚æ•°æœ‰æ•ˆä¸”åŒºåŸŸå·²æ­£ç¡®åŠ è½½
2. **è½®å»“æå–**ï¼šä½¿ç”¨è‡ªå®šä¹‰é˜ˆå€¼åœ¨æŒ‡å®šåŒºåŸŸå†…æå–è½®å»“
3. **è·ç¦»è®¡ç®—**ï¼šè®¡ç®—æœ€å°è·ç¦»ã€æœ€å¤§è·ç¦»å’Œé‡å¿ƒè·ç¦»
4. **ç²¾åº¦æ§åˆ¶**ï¼šæ ¹æ®è®¾ç½®çš„ç²¾åº¦å¯¹ç»“æœè¿›è¡Œå››èˆäº”å…¥
5. **è¯¦ç»†æ—¥å¿—**ï¼šæä¾›å®Œæ•´çš„å¤„ç†è¿‡ç¨‹æ—¥å¿—

## ğŸ“ å®é™…åº”ç”¨ç¤ºä¾‹ | Practical Usage Example

### ä¸»çª—å£ä»£ç ç¤ºä¾‹ | Main Window Example

```cpp
// mainwindow.cpp
void MainWindow::startMeasurementTask()
{
    // 1. é…ç½®æµ‹é‡ä»»åŠ¡å‚æ•°
    VisualTaskParams params;
    params.taskType = "Measure";
    params.templateName = "è·ç¦»æµ‹é‡æ¨¡æ¿";
    params.measureType = "Distance";
    params.edgeThreshold = 25;
    params.measurePrecision = 0.005;
    params.isValid = true;
    
    // 2. åŠ è½½æµ‹é‡æ¨¡æ¿å‚æ•°ï¼ˆåœ¨å·¥ä½œçº¿ç¨‹ä¸­ï¼‰
    if (!m_visualWorkThread->loadMeasureTemplateParams(params.templateName)) {
        QMessageBox::warning(this, "è­¦å‘Š", "æµ‹é‡æ¨¡æ¿å‚æ•°åŠ è½½å¤±è´¥ï¼");
        return;
    }
    
    // 3. è®¾ç½®å‚æ•°å¹¶å¯åŠ¨å¤„ç†
    m_visualWorkThread->setTaskParams(params);
    m_visualWorkThread->startBatchProcessing();
}
```

### å·¥ä½œçº¿ç¨‹å¤„ç†æµç¨‹ | Worker Thread Processing Flow

```cpp
// visualWorkThread.cpp
void visualWorkThread::process()
{
    // è·å–å½“å‰ä»»åŠ¡å‚æ•°
    VisualTaskParams currentParams = getCurrentTaskParams();
    
    if (currentParams.taskType == "Measure") {
        // ç¡®ä¿æµ‹é‡å‚æ•°å·²åŠ è½½
        if (!currentParams.isValid) {
            loadMeasureTemplateParams(currentParams.templateName);
        }
        
        // å¤„ç†å›¾åƒæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å›¾åƒ
        QDir imageDir(QApplication::applicationDirPath() + "/img");
        QFileInfoList fileList = imageDir.entryInfoList(QDir::Files);
        
        for (const QFileInfo& fileInfo : fileList) {
            QString imagePath = fileInfo.absoluteFilePath();
            
            // å¤„ç†å•ä¸ªæµ‹é‡ä»»åŠ¡
            processMeasureTask(imagePath);
        }
    }
}
```

## ğŸ¨ ç»“æœæ˜¾ç¤º | Result Display

### æµ‹é‡ç»“æœæ•°æ®ç»“æ„ | Measurement Result Data Structure

```cpp
struct VisualProcessResult {
    QString taskType = "Measure";
    bool success = true;
    QString errorMessage = "";
    QVariantMap resultData;           // è¯¦ç»†æµ‹é‡æ•°æ®
    QString imagePath;
    QDateTime processTime;
    
    // æµ‹é‡ç‰¹å®šç»“æœ
    double minDistance = 0.0;         // æœ€å°è·ç¦»
    double maxDistance = 0.0;         // æœ€å¤§è·ç¦»  
    double centroidDistance = 0.0;    // é‡å¿ƒè·ç¦»
};
```

### ç»“æœæ•°æ®å†…å®¹ | Result Data Content

```cpp
resultData["min_distance"] = 45.678;           // æœ€å°è·ç¦»
resultData["max_distance"] = 89.123;           // æœ€å¤§è·ç¦»
resultData["centroid_distance"] = 67.890;      // é‡å¿ƒè·ç¦»
resultData["edge_threshold"] = 25;              // ä½¿ç”¨çš„è¾¹ç¼˜é˜ˆå€¼
resultData["measure_precision"] = 0.005;        // æµ‹é‡ç²¾åº¦
resultData["measure_type"] = "Distance";        // æµ‹é‡ç±»å‹
resultData["template_name"] = "è·ç¦»æµ‹é‡æ¨¡æ¿";   // æ¨¡æ¿åç§°
resultData["region1_area"] = 1024;              // åŒºåŸŸ1é¢ç§¯
resultData["region2_area"] = 768;               // åŒºåŸŸ2é¢ç§¯
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®® | Performance Optimization Tips

### 1. é¢„åŠ è½½å‚æ•° | Pre-load Parameters
```cpp
// åœ¨åˆå§‹åŒ–æ—¶å°±åŠ è½½æ‰€æœ‰æ¨¡æ¿å‚æ•°ï¼Œé¿å…é‡å¤åŠ è½½
void visualWorkThread::initTemplate()
{
    loadMeasureTemplateParams("è·ç¦»æµ‹é‡æ¨¡æ¿");
    // åŠ è½½å…¶ä»–æ¨¡æ¿...
}
```

### 2. ç¼“å­˜åŒºåŸŸå¯¹è±¡ | Cache Region Objects
```cpp
// å°†åŠ è½½çš„åŒºåŸŸå¯¹è±¡ä½œä¸ºæˆå‘˜å˜é‡ç¼“å­˜
HObject m_Measyre_Rect1;  // å·²åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰
HObject m_Measyre_Rect2;  // å·²åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰
```

### 3. å¼‚å¸¸å¤„ç† | Exception Handling
```cpp
try {
    // æµ‹é‡å¤„ç†ä»£ç 
} catch (const HalconCpp::HException& e) {
    // Halconç‰¹å®šå¼‚å¸¸å¤„ç†
    LOG_ERROR(QString("Halconå¼‚å¸¸ï¼š%1").arg(QString(e.ErrorMessage())));
} catch (const std::exception& e) {
    // æ ‡å‡†å¼‚å¸¸å¤„ç†
    LOG_ERROR(QString("æ ‡å‡†å¼‚å¸¸ï¼š%1").arg(QString(e.what())));
}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤ | Troubleshooting

### å¸¸è§é—®é¢˜ | Common Issues

1. **åŒºåŸŸæ–‡ä»¶åŠ è½½å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
   - éªŒè¯HOBJæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»

2. **å‚æ•°è§£æé”™è¯¯**
   - ç¡®è®¤TUPæ–‡ä»¶æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥JSONæ–‡ä»¶è¯­æ³•

3. **è½®å»“æå–å¤±è´¥**
   - è°ƒæ•´è¾¹ç¼˜æ£€æµ‹é˜ˆå€¼
   - æ£€æŸ¥æµ‹é‡åŒºåŸŸæ˜¯å¦åˆç†

### è°ƒè¯•æ—¥å¿—ç¤ºä¾‹ | Debug Log Examples

```
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] ğŸ“‹ å¼€å§‹åŠ è½½è·ç¦»æµ‹é‡æ¨¡æ¿å‚æ•°ï¼šè·ç¦»æµ‹é‡æ¨¡æ¿
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] âœ… æˆåŠŸåŠ è½½æµ‹é‡å‚æ•°ï¼šè¾¹ç¼˜é˜ˆå€¼=25, æµ‹é‡ç²¾åº¦=0.005
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] âœ… æˆåŠŸåŠ è½½æµ‹é‡åŒºåŸŸ1ï¼šD:/MyCode/MyOperation/cmake-build-debug/config/halconParams/Measure/m_Measyre_Rect1.hobj
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] âœ… æˆåŠŸåŠ è½½æµ‹é‡åŒºåŸŸ2ï¼šD:/MyCode/MyOperation/cmake-build-debug/config/halconParams/Measure/m_Measyre_Rect2.hobj
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] ğŸ‰ è·ç¦»æµ‹é‡æ¨¡æ¿å‚æ•°åŠ è½½å®Œæˆï¼
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] ğŸ“ å¼€å§‹è·ç¦»æµ‹é‡å¤„ç†
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] ğŸ“ ä½¿ç”¨æµ‹é‡å‚æ•°ï¼šè¾¹ç¼˜é˜ˆå€¼=25, æµ‹é‡ç²¾åº¦=0.005
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] âœ… ä½¿ç”¨è‡ªå®šä¹‰è½®å»“æå–æ–¹æ³•
[ VisualWorkThread ] [ 2025-05-31 22:26:05 ] [ INFO ] âœ… è·ç¦»æµ‹é‡å®Œæˆï¼šæœ€å°è·ç¦»=45.680, æœ€å¤§è·ç¦»=89.125, é‡å¿ƒè·ç¦»=67.890
```

## ğŸ’¡ æœ€ä½³å®è·µ | Best Practices

1. **å‚æ•°éªŒè¯**ï¼šåœ¨ä½¿ç”¨å‚æ•°å‰å§‹ç»ˆéªŒè¯å…¶æœ‰æ•ˆæ€§
2. **èµ„æºç®¡ç†**ï¼šåŠæ—¶æ¸…ç†Halconå¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **é”™è¯¯å¤„ç†**ï¼šæä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤ç­–ç•¥
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®å¤„ç†æ­¥éª¤ï¼Œä¾¿äºè°ƒè¯•
5. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§å¤„ç†æ—¶é—´ï¼Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

---

**ä½œè€…**: èµ„æ·±å¼€å‘å·¥ç¨‹å¸ˆ | **æ—¥æœŸ**: 2025å¹´5æœˆ31æ—¥ | **ç‰ˆæœ¬**: v1.0

è¿™ä¸ªæŒ‡å—å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å·¥ä½œçº¿ç¨‹ä¸­çš„æµ‹é‡å‚æ•°ï¼Œæé«˜è§†è§‰å¤„ç†ç³»ç»Ÿçš„æ•ˆç‡å’Œå¯é æ€§ã€‚ 